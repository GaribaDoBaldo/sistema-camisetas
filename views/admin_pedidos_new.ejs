<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Novo Pedido</title>
</head>
<body>
  <h1>Novo Pedido</h1>

  <p><a href="/admin/pedidos">← Voltar</a></p>

  <% if (error) { %>
    <p style="color:red;"><%= error %></p>
  <% } %>

  <form method="POST" action="/admin/pedidos">
    <p>
      <label>Cliente:</label><br />
      <input type="text" name="customer_name" required />
    </p>

    <p>
      <label>Descrição (opcional):</label><br />
      <input type="text" name="description" />
    </p>

    <hr />

    <h3>Itens do pedido</h3>

    <table border="1" cellpadding="6" id="itemsTable">
      <thead>
        <tr>
          <th>Produto / Variação</th>
          <th>Quantidade</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody id="itemsBody">
        <!-- Linha inicial -->
        <tr>
          <td>
            <select name="variant_id[]" required>
              <option value="">-- Selecione --</option>
              <% variants.forEach(v => { %>
                <option value="<%= v.id %>">
                  <%= v.product_name %> | SKU: <%= v.sku || "-" %> | <%= v.color || "-" %> | <%= v.size || "-" %> | Estoque: <%= v.stock %>
                </option>
              <% }) %>
            </select>
          </td>
          <td>
            <input type="number" name="quantity[]" min="1" value="1" required />
          </td>
          <td>
            <button type="button" onclick="removeRow(this)">Remover</button>
          </td>
        </tr>
      </tbody>
    </table>

    <p>
      <button type="button" onclick="addRow()">+ Adicionar item</button>
    </p>

    <hr />

    <button type="submit">Criar Pedido</button>
  </form>

  <script>
    function addRow() {
      const body = document.getElementById("itemsBody");
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>
          <select name="variant_id[]" required>
            <option value="">-- Selecione --</option>
            ${getOptionsHtml()}
          </select>
        </td>
        <td>
          <input type="number" name="quantity[]" min="1" value="1" required />
        </td>
        <td>
          <button type="button" onclick="removeRow(this)">Remover</button>
        </td>
      `;

      body.appendChild(tr);
    }

    function removeRow(btn) {
      const body = document.getElementById("itemsBody");
      const tr = btn.closest("tr");

      // não deixa ficar sem nenhum item
      if (body.querySelectorAll("tr").length === 1) {
        alert("O pedido precisa ter pelo menos 1 item.");
        return;
      }

      tr.remove();
    }

    function getOptionsHtml() {
      // gera as options do select reaproveitando os dados do servidor
      const variants = <%- JSON.stringify(variants) %>;
      return variants.map(v => {
        const label = `${v.product_name} | SKU: ${v.sku || "-"} | ${v.color || "-"} | ${v.size || "-"} | Estoque: ${v.stock}`;
        return `<option value="${v.id}">${escapeHtml(label)}</option>`;
      }).join("");
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
