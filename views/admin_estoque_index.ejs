<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estoque</title>
</head>
<body>
<form method="GET" action="/admin/estoque" style="margin-bottom: 15px;">
  <div style="position: relative; display: inline-block;">
  <input
    id="qInput"
    name="q"
    value="<%= q || '' %>"
    placeholder="Buscar (nome, sku, cor, tamanho...)"
    autocomplete="off"
  />

  <div
    id="suggestions"
    style="
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      display: none;
      z-index: 9999;
      max-height: 200px;
      overflow-y: auto;
    "
  ></div>
</div>

  <label style="margin-left: 10px;">
    <input type="checkbox" name="low" value="1" <%= low ? "checked" : "" %> />
    S√≥ estoque baixo
  </label>

  <button type="submit">Filtrar</button>
</form>
  <h1>Estoque</h1>
  <p><a href="/admin/estoque/novo-produto">+ Novo produto</a></p>
  <p><a href="/dashboard">‚Üê Voltar</a></p>

  <h2>Produtos</h2>

  <% if (products.length === 0) { %>
    <p>Nenhum produto cadastrado ainda.</p>
  <% } else { %>
    <ul>
      <% products.forEach(p => { %>
        <li>
          <a href="/admin/estoque/produto/<%= p.id %>"><b><%= p.name %></b></a>
          (<%= p.category || "sem categoria" %>)
        </li>
      <% }) %>
    </ul>
  <% } %>

<p><a href="/admin/estoque/historico">üìú Ver hist√≥rico de movimenta√ß√µes</a></p>


  <hr/>

  <h2>Varia√ß√µes</h2>

  <% if (variants.length === 0) { %>
    <p>Nenhuma varia√ß√£o cadastrada ainda.</p>
  <% } else { %>
    <table border="1" cellpadding="6">
      <tr>
        <th>Produto</th>
        <th>SKU</th>
        <th>Cor</th>
        <th>Tamanho</th>
        <th>Estoque</th>
      </tr>

      <% variants.forEach(v => { %>
        <tr>
          <td><%= v.product_name %></td>
          <td><%= v.sku || "-" %></td>
          <td><%= v.color || "-" %></td>
          <td><%= v.size || "-" %></td>
          <td style="<%= v.stock <= v.min_stock ? 'color:red; font-weight:bold;' : '' %>">
  <%= v.stock %>
</td>
        </tr>
      <% }) %>
    </table>
  <% } %>
<script>
  const input = document.getElementById("qInput");
  const box = document.getElementById("suggestions");

  // pega o estado do checkbox low pra manter o filtro quando clicar na sugest√£o
  function isLowChecked() {
    const lowCheckbox = document.querySelector('input[name="low"]');
    return lowCheckbox && lowCheckbox.checked;
  }

  function hideBox() {
    box.style.display = "none";
    box.innerHTML = "";
  }

function showSuggestions(items) {
  if (!items || items.length === 0) return hideBox();

  box.innerHTML = items
    .map((item) => {
      const label = item.type || "Sugest√£o";
      const text = item.text || "";
      return `
        <div class="sItem" data-text="${text}" style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;">
          <b style="margin-right:6px;">${label}:</b> ${text}
        </div>`;
    })
    .join("");

  box.style.display = "block";

  box.querySelectorAll(".sItem").forEach((el) => {
    el.addEventListener("click", () => {
      input.value = el.getAttribute("data-text");

      const params = new URLSearchParams();
      params.set("q", input.value);
      if (isLowChecked()) params.set("low", "1");

      window.location.href = "/admin/estoque?" + params.toString();
    });
  });
}


  // debounce: espera voc√™ parar de digitar 250ms pra buscar
  let timer = null;

  input.addEventListener("input", () => {
    clearTimeout(timer);

    const q = input.value.trim();
    if (q.length < 2) return hideBox();

    timer = setTimeout(async () => {
      try {
        const res = await fetch(`/admin/estoque/sugestoes?q=${encodeURIComponent(q)}`);
        const items = await res.json();
        showSuggestions(items);
      } catch (e) {
        hideBox();
      }
    }, 250);
  });

  // se clicar fora, fecha a caixa
  document.addEventListener("click", (e) => {
    if (!box.contains(e.target) && e.target !== input) hideBox();
  });
</script>

</body>
</html>
